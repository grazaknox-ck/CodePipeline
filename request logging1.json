{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Transform" : "AWS::Serverless-2016-10-31",
  "Description" : "{env}-sls-{project_name}",
  "Parameters" : {},
  "Conditions" : {},  
  "Globals": {
	"Api" : {
		"Cors" : {
			"AllowHeaders" : "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'",
			"AllowMethods" : "'*'",
			"AllowOrigin" : "'*'"
		},
		"EndpointConfiguration" : "REGIONAL"
	 }
  },
  "Resources" : {
    "RequestLoggingBucket" : {
	   "Type" : "AWS::S3::Bucket",
	   "Properties" : {
		  "BucketName" : { "Fn::Sub" : "{env}-rl-${AWS::Region}-${AWS::AccountId}-6ea16bf8f4614f78876526412" },
		  "VersioningConfiguration" : { "Status" : "Enabled" }
	  },
	  "DeletionPolicy" : "Retain"
    },
	"RequestLoggingQueue" : { 
	   "Type" : "AWS::SQS::Queue",
	   "Properties" : {
		  "QueueName" : "ck-{env}-{project_name}"
	  }
    },
	"RequestLoggingQueuePolicy" : {
		"Type" : "AWS::SQS::QueuePolicy",
		"Properties" : {
			"Queues" : [
				{ "Ref" : "RequestLoggingQueue" }
			],
			"PolicyDocument" : 
				{   
				   "Version": "2012-10-17",
				   "Statement" : [{
					  "Effect": "Allow",  
					  "Principal" : "*",
					  "Action": [
						 "sqs:SendMessage"
					  ], 
					  "Resource": {  "Fn::GetAtt" : [ "RequestLoggingQueue", "Arn" ] }
				   }]
				}
		}
	},
	"RequestLoggingReaderFunction" : {
      "Type" : "AWS::Serverless::Function",
      "Properties": {
        "Handler": "Functions::{project_name_proper}.{project_name_proper}::{project_name_proper}Reader_Handler",
        "Runtime": "dotnetcore2.1",
        "CodeUri": "{code_location_to_s3}",
        "Description": "{env}-sls-RequestLoggingReader",
        "FunctionName": "{env}-sls-RequestLoggingReader",
        "MemorySize": 512,
        "Timeout": 30,
        "Role": null,
        "Policies": [ 
			"AWSLambdaBasicExecutionRole",
			{
                "Version": "2012-10-17",
                "Statement": [
                    {
					  "Effect": "Allow",
					  "Action": ["s3:ListBucket"],
					  "Resource":  { "Fn::GetAtt" : [ "RequestLoggingBucket", "Arn" ] }
					},
					{
                        "Effect": "Allow",
                        "Action": [
							"s3:GetObject"
						],
                        "Resource": { "Fn::Join" : [ "/", [ { "Fn::GetAtt" : [ "RequestLoggingBucket", "Arn" ] }, "*" ] ] }
						
                    }
                ]
            },
			{
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Action": [
							"dynamodb:UpdateItem"
						],
                        "Resource":  { "Fn::Sub" : "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/{ENV}_ID_US-West-2" }
                    }
                ]
            }
		],
		"Environment" : {
			"Variables" : {
				"AwsAccountNumber" : {"Fn::Sub" : "${AWS::AccountId}" }
			}
		},
		"Tags" : {
			"Name" : "{project_name_proper}"
		},
        "Tracing": "PassThrough",
        "Events": {
          "PutResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/{project_name_proper}Reader/{xRefNum}",
              "Method": "GET"			  
            }
          }
        }
      }
    },
    "RequestLoggingFunction" : {
      "Type" : "AWS::Serverless::Function",
      "Properties": {
        "Handler": "Functions::{project_name_proper}.{project_name_proper}::{project_name_proper}_Handler",
        "Runtime": "dotnetcore2.1",
        "CodeUri": "{code_location_to_s3}",
        "Description": "{env}-sls-{project_name}",
        "FunctionName": "{env}-sls-{project_name}",
        "MemorySize": 512,
        "Timeout": 30,
        "Role": null,
        "Policies": [ 
			"AWSLambdaBasicExecutionRole",
			{
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Action": [
							"s3:PutObject",
							"sqs:ReceiveMessage",
							"sqs:DeleteMessage",
							"sqs:GetQueueAttributes"
						],
                        "Resource": [
							{ "Fn::GetAtt" : [ "RequestLoggingQueue", "Arn"] },
							{ "Fn::Join" : [ "/", [ { "Fn::GetAtt" : [ "RequestLoggingBucket", "Arn" ] }, "*" ] ] }
						]
                    }
                ]
            }
		],
		"Environment" : {
			"Variables" : {
				"AwsAccountNumber" : {"Fn::Sub" : "${AWS::AccountId}" }
			}
		},
		"Tags" : {
			"Name" : "{project_name_proper}"
		},
        "Tracing": "PassThrough",
        "Events": {}
      }
    },
	"LambdaInvokePermission": {
	  "Type": "AWS::Lambda::Permission",
	  "Properties": {
		"FunctionName" : {"Fn::GetAtt" : ["RequestLoggingFunction", "Arn"]},
		"Principal": "sqs.amazonaws.com",
		"Action": "lambda:InvokeFunction",
		"SourceArn" : {"Fn::GetAtt" : ["RequestLoggingQueue", "Arn"] }
	  }
	},
	"SqsLambdaTrigger": {
	  "Type": "AWS::Lambda::EventSourceMapping",
	  "Properties": {
		"FunctionName" : {"Fn::GetAtt" : ["RequestLoggingFunction", "Arn"]},
		"BatchSize": "10",
		"Enabled": "true",
		"EventSourceArn" : {"Fn::GetAtt" : ["RequestLoggingQueue", "Arn"] }
	  }
	}
  },
  "Outputs" : {}
}